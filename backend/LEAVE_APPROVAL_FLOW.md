# Flow การทำงานและวิธีใช้งานระบบอนุมัติการลา

## 📋 ภาพรวมระบบ

ระบบอนุมัติการลามี 3 ระดับสิทธิ์:
- **Admin**: ผู้ดูแลระบบ - เห็นและอนุมัติการลาของทุกคน
- **Manager**: หัวหน้าแผนก - เห็นและอนุมัติการลาของคนในแผนกตัวเองเท่านั้น
- **Employee**: พนักงานทั่วไป - ขออนุมัติการลาได้ แต่ไม่สามารถอนุมัติได้

---

## 🔄 Flow การทำงาน

### 1. Flow สำหรับ Employee (พนักงานทั่วไป)

```
┌─────────────────┐
│ Employee Login  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Home Screen   │
│  - เข้างาน      │
│  - ออกงาน       │
│  - ลางาน ◄──────┼── ขอลางาน
│  - เงินเดือน    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Request Leave   │
│ Screen          │
│  - เลือกประเภท  │
│  - เลือกวันที่  │
│  - กรอกเหตุผล   │
│  - ส่งคำขอ      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Status: Pending│
│  รออนุมัติ      │
└─────────────────┘
```

**ขั้นตอน:**
1. Login ด้วย user ที่ `role = 'employee'`
2. ไปที่หน้า Home
3. กดปุ่ม "ลางาน"
4. กรอกข้อมูลการลา (ประเภท, วันที่, เหตุผล)
5. กด "ส่งคำขอลางาน"
6. ระบบจะส่งคำขอไปยัง Manager หรือ Admin
7. ตรวจสอบสถานะได้ที่ "ประวัติการลา"

---

### 2. Flow สำหรับ Manager (หัวหน้าแผนก)

```
┌─────────────────┐
│  Manager Login  │
│  (role=manager) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Home Screen   │
│  - การ์ดปกติ    │
│  - การ์ดหัวหน้า  │
│    แผนก ◄───────┼── เห็นการ์ดนี้
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ กด "อนุมัติการลา"│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Leave Management│
│ Screen          │
│  - รายการรอ     │
│    อนุมัติ      │
│  - ข้อมูลพนักงาน│
│  - วันที่ลา     │
│  - เหตุผล       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  อนุมัติ/ปฏิเสธ  │
│  - กดอนุมัติ    │
│  - กดปฏิเสธ     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Status Updated  │
│ - Approved      │
│ - Rejected      │
└─────────────────┘
```

**ขั้นตอน:**
1. Login ด้วย user ที่ `role = 'manager'`
2. ไปที่หน้า Home
3. **เห็นการ์ด "หัวหน้าแผนก"** ด้านล่าง
4. กดปุ่ม **"อนุมัติการลา"** ในการ์ดนั้น
5. เข้าสู่หน้า "อนุมัติการลา"
6. เห็นรายการวันลาที่รออนุมัติ (เฉพาะคนในแผนกเดียวกัน)
7. ดูข้อมูลพนักงาน, วันที่ลา, เหตุผล
8. กด **"อนุมัติ"** หรือ **"ปฏิเสธ"**
9. ถ้าปฏิเสธ สามารถกรอกเหตุผลได้ (ไม่บังคับ)
10. ระบบจะอัพเดทสถานะการลา

---

### 3. Flow สำหรับ Admin (ผู้ดูแลระบบ)

```
┌─────────────────┐
│   Admin Login   │
│  (role=admin)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Admin Dashboard │
│  - HR Dashboard │
│  - จัดการพนักงาน│
│  - จัดการเข้างาน│
│  - จัดการลางาน ◄─┼── เข้าจากนี่
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Leave Management│
│ Screen          │
│  - เห็นทั้งหมด  │
│  - ทุกแผนก      │
│  - อนุมัติ/ปฏิเสธ│
└─────────────────┘
```

**ขั้นตอน:**
1. Login ด้วย user ที่ `role = 'admin'`
2. ไปที่ Admin Dashboard
3. กดการ์ด **"จัดการการลางาน"**
4. เข้าสู่หน้า "อนุมัติการลา"
5. เห็นรายการวันลาทั้งหมด (ทุกแผนก)
6. อนุมัติ/ปฏิเสธได้เหมือน Manager

---

## 🎯 วิธีใช้งานแบบละเอียด

### สำหรับ Admin: ตั้งค่า Manager

#### 1. แก้ไข Database Schema (ครั้งแรกเท่านั้น)
```bash
mysql -u root -p humans < backend/add_manager_role.sql
```

#### 2. ตั้งค่าให้ User เป็น Manager

**วิธีที่ 1: ผ่านหน้า Admin Dashboard (แนะนำ)**
1. Login ด้วย admin
2. ไปที่ **Admin Dashboard**
3. กด **"จัดการพนักงาน"**
4. กดปุ่ม **แก้ไข** (ไอคอนดินสอ) ของพนักงานที่ต้องการ
5. ใน dropdown **"Role"** เลือก **"Manager"**
6. กด **"บันทึก"**

**วิธีที่ 2: ผ่าน SQL**
```sql
USE humans;

-- ตั้งค่าให้ user เป็น manager
UPDATE login 
SET role = 'manager' 
WHERE user_id = 5;  -- เปลี่ยน user_id ตามต้องการ
```

#### 3. ตรวจสอบ
```sql
-- ตรวจสอบ user ที่เป็น manager
SELECT 
  l.user_id,
  l.username,
  l.email,
  l.role,
  CONCAT(e.first_name, ' ', e.last_name) as employee_name,
  e.department
FROM login l
LEFT JOIN employees e ON l.user_id = e.user_id
WHERE l.role = 'manager';
```

---

### สำหรับ Manager: อนุมัติการลา

#### 1. Login
- Login ด้วย user ที่ `role = 'manager'`
- ต้องมี `department` ในตาราง `employees` ด้วย

#### 2. เข้าถึงหน้า Leave Management
- หน้า Home จะแสดงการ์ด **"หัวหน้าแผนก"**
- กดปุ่ม **"อนุมัติการลา"**

#### 3. ดูรายการวันลาที่รออนุมัติ
- เห็นเฉพาะวันลาของคนในแผนกเดียวกัน
- แต่ละการ์ดแสดง:
  - ข้อมูลพนักงาน (ชื่อ, ตำแหน่ง, แผนก, email)
  - ประเภทการลา (ลาป่วย/ลากิจ)
  - ช่วงวันที่ลา
  - จำนวนวันลา
  - เหตุผล
  - วันที่ส่งคำขอ

#### 4. อนุมัติ/ปฏิเสธ
- **อนุมัติ**: กดปุ่ม **"อนุมัติ"** → ยืนยัน → สำเร็จ
- **ปฏิเสธ**: กดปุ่ม **"ปฏิเสธ"** → กรอกเหตุผล (ไม่บังคับ) → ยืนยัน → สำเร็จ

---

### สำหรับ Employee: ขอลา

#### 1. Login
- Login ด้วย user ที่ `role = 'employee'`

#### 2. ขอลา
- หน้า Home → กดปุ่ม **"ลางาน"**
- กรอกข้อมูล:
  - เลือกประเภทการลา (ลาป่วย/ลากิจ)
  - เลือกวันที่เริ่มต้น
  - เลือกวันสิ้นสุด
  - กรอกเหตุผล
  - แนบเอกสาร (ถ้าจำเป็น)
- กด **"ส่งคำขอลางาน"**

#### 3. ตรวจสอบสถานะ
- ไปที่ **"ประวัติการลา"** เพื่อดูสถานะ
- สถานะ: Pending (รออนุมัติ), Approved (อนุมัติแล้ว), Rejected (ปฏิเสธ)

---

## 🔍 ตัวอย่างการใช้งาน

### ตัวอย่างที่ 1: Manager อนุมัติการลา

**สถานการณ์:**
- Manager: สมศักดิ์ (แผนก Human Resources)
- Employee: พนักงานในแผนก Human Resources ขอลา

**ขั้นตอน:**
1. สมศักดิ์ login ด้วย user ที่ `role = 'manager'`
2. เห็นการ์ด "หัวหน้าแผนก" ในหน้า Home
3. กด "อนุมัติการลา"
4. เห็นรายการวันลาของพนักงานในแผนก Human Resources
5. ดูข้อมูลการลา → กด "อนุมัติ"
6. ระบบอัพเดทสถานะเป็น "Approved"

### ตัวอย่างที่ 2: Manager ไม่เห็นวันลาของแผนกอื่น

**สถานการณ์:**
- Manager: สมศักดิ์ (แผนก Human Resources)
- Employee: Montita (แผนก Engineering) ขอลา

**ผลลัพธ์:**
- สมศักดิ์ **ไม่เห็น** วันลาของ Montita
- เพราะอยู่คนละแผนก

### ตัวอย่างที่ 3: Admin เห็นทุกคน

**สถานการณ์:**
- Admin: admin
- มีวันลารออนุมัติจากหลายแผนก

**ผลลัพธ์:**
- Admin เห็นวันลาของทุกคน
- สามารถอนุมัติ/ปฏิเสธได้ทั้งหมด

---

## ⚠️ ข้อควรระวัง

1. **Manager ต้องมี Department**
   - ถ้า Manager ไม่มี `department` ในตาราง `employees` จะไม่เห็นวันลาใดๆ

2. **การกรองตามแผนก**
   - Manager เห็นเฉพาะวันลาของคนในแผนกเดียวกัน
   - ตรวจสอบว่า `department` ตรงกัน

3. **Role ต้องถูกต้อง**
   - ตรวจสอบว่า `role = 'manager'` ในตาราง `login`
   - ไม่ใช่ `is_manager` ในตาราง `employees`

4. **ข้อมูลพนักงานต้องครบ**
   - Manager ต้องมีข้อมูลในตาราง `employees`
   - ต้องมี `department` ที่ถูกต้อง

---

## 📊 สรุปสิทธิ์

| Role | เห็นการ์ดหัวหน้าแผนก | เข้าถึง Leave Management | เห็นวันลาของ |
|------|---------------------|-------------------------|-------------|
| **Admin** | ❌ | ✅ (ผ่าน Admin Dashboard) | ทุกคน |
| **Manager** | ✅ | ✅ | คนในแผนกเดียวกัน |
| **Employee** | ❌ | ❌ | ไม่มีสิทธิ์ |

---

## 🛠️ Troubleshooting

### ปัญหา: Manager ไม่เห็นการ์ด "หัวหน้าแผนก"
**แก้ไข:**
1. ตรวจสอบว่า `role = 'manager'` ในตาราง `login`
2. ตรวจสอบว่า user มีข้อมูลในตาราง `employees`
3. Logout และ Login ใหม่

### ปัญหา: Manager ไม่เห็นวันลา
**แก้ไข:**
1. ตรวจสอบว่า Manager มี `department` ในตาราง `employees`
2. ตรวจสอบว่าพนักงานที่ขอลามี `department` ตรงกัน
3. ตรวจสอบว่ามีวันลาที่ `status = 'pending'`

### ปัญหา: Dropdown ไม่มี "Manager"
**แก้ไข:**
1. ตรวจสอบว่าแก้ไข database schema แล้ว
2. รัน `backend/add_manager_role.sql` อีกครั้ง
3. Restart backend server

---

## 📝 ไฟล์ที่เกี่ยวข้อง

- `backend/add_manager_role.sql` - แก้ไข database schema
- `backend/routes/leave.js` - API สำหรับอนุมัติการลา
- `lib/screens/admin/employee_management_screen.dart` - หน้า CRUD พนักงาน
- `lib/screens/admin/leave_management_screen.dart` - หน้าอนุมัติการลา
- `lib/screens/home_screen.dart` - หน้า Home (แสดงการ์ดหัวหน้าแผนก)
- `lib/models/user_model.dart` - Model สำหรับ User

